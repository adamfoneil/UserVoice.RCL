@using Dapper.QX.Extensions
@inject UserVoiceDataContext Data

<div class="d-flex justify-content-center my-2">
    @foreach (var typeGrp in items.GroupBy(row => row.Type))
    {
        <div class="mx-3">
            <RadzenButton Icon="@Data.TypeInfo[typeGrp.Key].Icon" 
                Text="@Data.TypeInfo[typeGrp.Key].PluralTextWithCount(typeGrp.Count())" Click="@(() => ApplyFilter(typeGrp.Key))" 
                ButtonStyle="ButtonStyle.Secondary"/>
        </div>
    }
    @if (query.Type.HasValue)
    {
        <div class="mx-3">
            <RadzenButton Text="Show All" Click="@(async () => { query.Type = null; await Refresh(); })"/>
        </div>
    }
</div>

<RadzenDataList Data="@items">
    <Template Context="row">        
        <div class="d-flex justify-content-between">
            <div class="d-flex align-items-center" style="cursor:pointer" @onclick="@(() => ToggleSection(row.Id))">
                <div class="text-muted d-flex align-items-center">
                    <RadzenIcon Icon="@Data.TypeInfo[row.Type].Icon" class="mr-1 me-2" Style="@Data.TypeInfo[row.Type].Style"/>                    
                    <span class="text-muted">#@(row.Id)</span>                    
                </div>

                <div class="ms-2 ml-2">
                    @row.Title
                </div>

                <div class="ms-2 ml-2 text-muted small" title="@row.DateInfo()">
                    @row.PostDate.ElapsedRelative(CurrentUser?.LocalTime ?? DateTime.Now)
                </div>

                <ExpandToggle OnToggled="@((val) => OnSectionToggled(row.Id, val))" @bind-Value="@expand[row.Id]" class="ml-2 ms-2"/>
            </div>

            <div>
                @if (row.ItemStatus.HasValue)
                {
                    <div>
                        <RadzenIcon Icon="@Data.StatusInfo[row.ItemStatus.Value].Icon" Style="@Data.StatusInfo[row.ItemStatus.Value].Style" />
                    </div>                    
                }

                @if (acceptanceRequests[row.Id].Any())
                {
                    <div>
                        @foreach (var responseGrp in acceptanceRequests[row.Id].GroupBy(row => row.Response))
                        {
                            <div class="d-flex align-items-start">
                                <div class="d-flex align-items-center">
                                    <RadzenIcon Icon="@Data.ResponseInfo[responseGrp.Key].Icon" Style="@Data.ResponseInfo[responseGrp.Key].Style" class="me-1 mr-1" />
                                    <span>@Data.ResponseInfo[responseGrp.Key].Text</span>
                                </div>
                                <ul>
                                    @foreach (var ar in responseGrp)
                                    {
                                        <li>@ar.UserName</li>
                                    }
                                </ul>
                            </div>                            
                        }
                    </div>
                }
            </div>            
        </div>
        @if (expand[row.Id])
        {
            <div class="ml-5 ms-5 mt-2">
                <RadzenCard>
                    @ToMarkup(row.Body)
                </RadzenCard>                
            </div>            
            <div>
                <CommentEditor Comments="@comments[row.Id]" ItemId="@row.Id" CurrentUser="@CurrentUser" CommentSaved="OnCommentSaved"/>
            </div>
        }
    </Template>
</RadzenDataList>

@code {
    ListItems query = new();
    IEnumerable<ListItemsResult> items = Enumerable.Empty<ListItemsResult>();
    ILookup<int, Comment> comments = Enumerable.Empty<Comment>().ToLookup(row => row.ItemId);
    ILookup<int, AcceptanceRequest> acceptanceRequests = Enumerable.Empty<AcceptanceRequest>().ToLookup(row => row.ItemId);
    Dictionary<int, bool> expand = new();    

    [Parameter]
    public User? CurrentUser { get; set; }

    MarkupString ToMarkup(string? input) => new MarkupString(input ?? string.Empty);

    protected override async Task OnInitializedAsync()
    {
        await Refresh();
    }

    public async Task Refresh()
    {
        items = await query.ExecuteAsync(Data.GetConnection);

        acceptanceRequests = (await new ListAcceptanceRequests()
        {
            ItemIds = items.Select(row => row.Id).ToDataTable()
        }.ExecuteAsync(Data.GetConnection)).ToLookup(row => row.ItemId);

        await RefreshComments();

        expand = items.ToDictionary(row => row.Id, row => false);
        StateHasChanged();
    }

    async Task ApplyFilter(ItemType itemType)
    {
        query.Type = itemType;
        await Refresh();
    }

    void ToggleSection(int itemId)
    {
        expand[itemId] = !expand[itemId];
        StateHasChanged();
    }

    void OnSectionToggled(int rowId, bool expanded)
    {
        expand[rowId] = !expanded;
        StateHasChanged();
    }

    async Task RefreshComments()
    {
        comments = (await new ListComments()
        {
            ItemIds = items.Select(row => row.Id).ToDataTable()
        }.ExecuteAsync(Data.GetConnection)).ToLookup(row => row.ItemId);
    }

    async Task OnCommentSaved(Comment comment)
    {
        await RefreshComments();
    }
}